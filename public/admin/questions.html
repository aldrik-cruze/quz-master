<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1f2937">
    <title>Manage Questions - Quiz Master</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="../css/mobile.css">
</head>
<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <div>
                    <h2>üéØ Quiz Master</h2>
                    <p>Admin Panel</p>
                </div>
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" style="display: none;">‚ò∞</button>
            </div>
            <nav class="sidebar-nav" id="sidebarNav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="users.html" class="nav-item">
                    <span>üë•</span> Users
                </a>
                <a href="questions.html" class="nav-item active">
                    <span>üìù</span> Questions
                </a>
                <a href="../dashboard.html" class="nav-item">
                    <span>üè†</span> Back to Site
                </a>
                <div class="sidebar-footer">
                    <button onclick="logout()" class="btn btn-secondary btn-block">Logout</button>
                </div>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h1>Manage Questions</h1>
                <button onclick="showAddQuestionModal()" class="btn btn-primary">Add Question</button>
            </div>

            <div class="admin-section">
                <div class="filter-bar">
                    <select id="topicFilter" onchange="filterQuestions()" class="form-control">
                        <option value="">All Topics</option>
                    </select>
                </div>

                <div id="questionsTable" class="table-container">
                    <!-- Questions will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Question Modal -->
    <div id="questionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Question</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <form id="questionForm" class="modal-form">
                <input type="hidden" id="questionId">
                
                <div class="form-group">
                    <label for="topicId">Topic *</label>
                    <select id="topicId" required class="form-control">
                        <option value="">Select Topic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="questionText">Question *</label>
                    <textarea id="questionText" required class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="optionA">Option A *</label>
                    <input type="text" id="optionA" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="optionB">Option B *</label>
                    <input type="text" id="optionB" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="optionC">Option C *</label>
                    <input type="text" id="optionC" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="optionD">Option D *</label>
                    <input type="text" id="optionD" required class="form-control">
                </div>

                <div class="form-group">
                    <label for="correctAnswer">Correct Answer *</label>
                    <select id="correctAnswer" required class="form-control">
                        <option value="a">A</option>
                        <option value="b">B</option>
                        <option value="c">C</option>
                        <option value="d">D</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="difficulty">Difficulty *</label>
                    <select id="difficulty" required class="form-control">
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" onclick="closeModal()" class="btn btn-outline">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Question</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/mobile.js"></script>
    <script>
        let allQuestions = [];
        let allTopics = [];

        async function init() {
            await verifyAdmin();
            await loadTopics();
            await loadQuestions();
        }

        async function loadTopics() {
            try {
                const response = await fetch(API_URL + '/quiz/topics');
                const data = await response.json();
                allTopics = data.topics;

                const topicFilter = document.getElementById('topicFilter');
                const topicSelect = document.getElementById('topicId');

                allTopics.forEach(topic => {
                    topicFilter.innerHTML += `<option value="${topic.id}">${topic.name}</option>`;
                    topicSelect.innerHTML += `<option value="${topic.id}">${topic.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetchWithAuth('/admin/questions');
                const data = await response.json();
                allQuestions = data.questions;
                displayQuestions(allQuestions);
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Failed to load questions');
            }
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsTable');

            if (questions.length === 0) {
                container.innerHTML = '<p class="no-data">No questions found</p>';
                return;
            }

            container.innerHTML = `
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Topic</th>
                            <th>Question</th>
                            <th>Difficulty</th>
                            <th>Correct</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${questions.map(q => `
                            <tr>
                                <td>${q.id}</td>
                                <td>${q.topic_name}</td>
                                <td class="question-preview">${q.question_text.substring(0, 80)}${q.question_text.length > 80 ? '...' : ''}</td>
                                <td><span class="badge badge-${q.difficulty === 'easy' ? 'success' : q.difficulty === 'medium' ? 'warning' : 'danger'}">${q.difficulty}</span></td>
                                <td><strong>${q.correct_answer.toUpperCase()}</strong></td>
                                <td>
                                    <button onclick="editQuestion(${q.id})" class="btn btn-small btn-primary">Edit</button>
                                    <button onclick="deleteQuestion(${q.id})" class="btn btn-small btn-danger">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterQuestions() {
            const topicId = document.getElementById('topicFilter').value;
            if (!topicId) {
                displayQuestions(allQuestions);
            } else {
                const filtered = allQuestions.filter(q => q.topic_id == topicId);
                displayQuestions(filtered);
            }
        }

        function showAddQuestionModal() {
            document.getElementById('modalTitle').textContent = 'Add Question';
            document.getElementById('questionForm').reset();
            document.getElementById('questionId').value = '';
            document.getElementById('questionModal').style.display = 'flex';
        }

        function editQuestion(id) {
            const question = allQuestions.find(q => q.id === id);
            if (!question) return;

            document.getElementById('modalTitle').textContent = 'Edit Question';
            document.getElementById('questionId').value = question.id;
            document.getElementById('topicId').value = question.topic_id;
            document.getElementById('questionText').value = question.question_text;
            document.getElementById('optionA').value = question.option_a;
            document.getElementById('optionB').value = question.option_b;
            document.getElementById('optionC').value = question.option_c;
            document.getElementById('optionD').value = question.option_d;
            document.getElementById('correctAnswer').value = question.correct_answer;
            document.getElementById('difficulty').value = question.difficulty;
            document.getElementById('questionModal').style.display = 'flex';
        }

        async function deleteQuestion(id) {
            if (!confirm('Are you sure you want to delete this question?')) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/admin/questions/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Question deleted successfully');
                    await loadQuestions();
                } else {
                    alert('Failed to delete question');
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                alert('Failed to delete question');
            }
        }

        function closeModal() {
            document.getElementById('questionModal').style.display = 'none';
        }

        document.getElementById('questionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const questionId = document.getElementById('questionId').value;
            const formData = {
                topicId: document.getElementById('topicId').value,
                questionText: document.getElementById('questionText').value,
                optionA: document.getElementById('optionA').value,
                optionB: document.getElementById('optionB').value,
                optionC: document.getElementById('optionC').value,
                optionD: document.getElementById('optionD').value,
                correctAnswer: document.getElementById('correctAnswer').value,
                difficulty: document.getElementById('difficulty').value
            };

            try {
                let response;
                if (questionId) {
                    response = await fetchWithAuth(`/admin/questions/${questionId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetchWithAuth('/admin/questions', {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    alert(questionId ? 'Question updated successfully' : 'Question added successfully');
                    closeModal();
                    await loadQuestions();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to save question');
                }
            } catch (error) {
                console.error('Error saving question:', error);
                alert('Failed to save question');
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('questionModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        function toggleMobileMenu() {
            const nav = document.getElementById('sidebarNav');
            nav.classList.toggle('mobile-active');
        }

        // Close menu when clicking a nav item on mobile
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        const nav = document.getElementById('sidebarNav');
                        nav.classList.remove('mobile-active');
                    }
                });
            });
        });

        init();
    </script>
</body>
</html>
